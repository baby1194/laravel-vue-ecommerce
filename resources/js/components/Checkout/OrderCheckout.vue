<template>
    <div>
        <h1 class="h-10 p-6 text-4xl font-bold text-center">Checkout</h1>
        <section class="mt-10">
            <div v-if="localState.orderError" class="h-10 p-4">
                <span class="text-lg text-center text-red-500"
                    >Error during order. Please retry</span
                >
            </div>
            <div
                v-for="product in getCartContent"
                :key="product.id"
                class="container mx-auto mt-4 flex border border-gray-300 rounded-lg shadow flex-wrap flex-row justify-around items-center content-center"
            >
                <div class="lg:m-2 xl:m-4 xl:w-1/6 lg:w-1/6 sm:m-2 w-auto">
                    <span class="block mt-2 text-xl font-bold"
                        >Remove: <br
                    /></span>
                    <span
                        class="inline-block mt-4 lg:h-12 h-20 w-32 md:w-full lg:w-full xl:w-full"
                    >
                        <a tabindex="0" @click="removeProductFromCart(product)">
                            <img
                                class="mt-2 ml-4 cursor-pointer"
                                :class="{
                                    removing: localState.removingCartItem,
                                }"
                                alt="Remove icon"
                                aria-label="Remove"
                                src="../../../img/svg/Remove.svg"
                            />
                        </a>
                    </span>
                </div>
                <div class="lg:m-2 xl:m-4 xl:w-1/6 lg:w-1/6 sm:m-2 w-auto">
                    <span class="block mt-2 text-xl font-bold"
                        >Name: <br
                    /></span>
                    <span
                        class="text-lg inline-block mt-4 lg:h-12 h-20 w-32 md:w-full lg:w-full xl:w-full"
                        >{{ product.name }}</span
                    >
                </div>
                <div class="lg:m-2 xl:m-4 xl:w-1/6 lg:w-1/6 sm:m-2 w-auto">
                    <span class="block mt-2 text-xl font-bold"
                        >Quantity: <br />
                    </span>
                    <span
                        class="text-lg inline-block mt-4 lg:h-12 h-20 w-32 md:w-full lg:w-full xl:w-full"
                    >
                        {{ product.quantity }}
                    </span>
                </div>
                <div class="item">
                    <span class="block mt-2 text-xl font-bold"
                        >Price: <br
                    /></span>
                    <span
                        class="text-lg inline-block mt-4 lg:h-12 h-20 w-32 md:w-full lg:w-full xl:w-full"
                    >
                        {{ formatPrice(product.price) }}
                    </span>
                </div>
            </div>
            <div
                v-if="getCartQuantity"
                class="container mx-auto mt-2 flex flex-wrap flex-row justify-end items-end content-center"
            >
                <span class="p-4 text-2xl font-extrabold text-right"
                    >Total: {{ formatPrice(getCartTotal) }}</span
                >
            </div>
        </section>
        <h2 v-if="!getCartQuantity" class="m-4 text-3xl text-center">
            Cart is currently empty
        </h2>
        <div v-if="getCartQuantity">
            <h2 class="h-10 m-2 text-2xl font-bold text-center">
                Customer Details
            </h2>
            <div class="flex justify-center w-full align-center">
                <order-form></order-form>
            </div>

            <transition name="fade">
                <div v-show="getCustomerDetails.firstName">
                    <div class="flex justify-center w-full align-center">
                        <span
                            class="h-10 p-4 text-lg font-bold text-center text-red-500"
                            >Use the following card details for testing:
                            <br />4242424242424242 <br />CVC any 3 digits
                            <br />Any future date <br />Any zip code
                        </span>
                    </div>
                    <h2 class="h-10 p-4 mt-32 text-2xl font-bold text-center">
                        Stripe payment
                    </h2>
                    <div class="flex justify-center w-full p-4 align-center">
                        <div
                            id="card-element"
                            class="w-full h-16 mt-6 lg:w-5/12 xl:w-5/12"
                        >
                            Stripe
                        </div>
                    </div>
                    <div class="flex justify-center w-full align-center">
                        <button
                            class="p-2 mt-4 mb-4 text-lg font-bold text-white bg-blue-500 rounded hover:bg-blue-700;"
                            :class="{
                                disabledButton: localState.paymentIsProcessing,
                            }"
                            :disabled="localState.paymentIsProcessing"
                            @click="checkout(product)"
                        >
                            Place order
                        </button>
                    </div>
                </div>
            </transition>
        </div>
    </div>
</template>

<script setup>
import { reactive, onMounted } from "vue";
import { storeToRefs } from "pinia";
import { loadStripe } from "@stripe/stripe-js";

import { formatPrice } from "../../utils/functions";
import { useCart } from "../../store/useCart";

const localState = reactive({
    removingCartItem: false,
    paymentIsProcessing: false,
    stripe: {},
    cardElement: {},
    customer: {},
    orderError: false,
});

// https://formkit.com/guides/build-a-multi-step-form

const store = useCart();

const { getCartQuantity, getCartContent, getCartTotal, getCustomerDetails } =
    storeToRefs(useCart());

const removeProductFromCart = (product) => {
    localState.removingCartItem = true;
    store.removeFromCart(product);
    localState.removingCartItem = false;
};

onMounted(async () => {
    // localState.stripe =

    let stripe = await loadStripe(process.env.MIX_STRIPE_KEY);
    const elements = stripe.elements();

    const cardElement = elements.create("card", {
        classes: {
            base: "bg-gray-100 rounded border border-gray-300 focus:border-indigo-500 text-base outline-none text-gray-700 p-3 leading-8 transition-colors duration-200 ease-in-out",
        },
    });

    cardElement.mount("#card-element");

    /* 
   localState.cardElement = elements.create("card", {
        classes: {
            base: "bg-gray-100 rounded border border-gray-300 focus:border-indigo-500 text-base outline-none text-gray-700 p-3 leading-8 transition-colors duration-200 ease-in-out",
        },
    });
    */
    // localState.cardElement.mount("#card-element");
});

const checkout = async () => {
    /* const { customer } = store.state;
      const {
        paymentMethod,
        error,
      } = await localState.stripe.createPaymentMethod(
        'card',
        localState.cardElement,
        {
          billing_details: {
            name: `${customer.firstName} ${customer.lastName}`,
            email: customer.email,
            address: {
              line1: customer.address,
              city: customer.city,
              state: customer.state,
              postal_code: customer.zipcode,
            },
          },
        },
      );*/
};
</script>

<style>
.disabledButton {
    @apply cursor-not-allowed opacity-50;
}

.flex-container {
    @apply container mx-auto mt-4 flex border border-gray-300 rounded-lg shadow flex-wrap flex-row justify-around items-center content-center;
}

.item {
    @apply lg:m-2 xl:m-4 xl:w-1/6 lg:w-1/6 sm:m-2 w-auto;
}

.inline-block {
    @apply inline-block mt-4 lg:h-12 h-20 w-32 md:w-full lg:w-full xl:w-full;
}

.removing {
    @apply animate-spin cursor-not-allowed;
}

.fade-enter-active,
.fade-leave-active {
    transition: all 0.5s ease;
}

.fade-enter-from,
.fade-leave-to {
    opacity: 0;
}
</style>
